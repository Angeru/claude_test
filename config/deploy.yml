# Kamal deployment configuration
# Docs: https://kamal-deploy.org

service: warband-campaign-manager

# Docker image name (change to your Docker Hub user or registry)
image: angeru/warband-campaign-manager

# Deploy to your DigitalOcean droplet
servers:
  web:
    hosts:
      - 142.93.228.193
    options:
      # Mount a volume for SQLite persistence
      volume:
        - warband_storage:/rails/storage

# Container registry credentials (Docker Hub by default)
registry:
  username: angeru
  password:
    - KAMAL_REGISTRY_PASSWORD

# Environment variables for the app
env:
  clear:
    RAILS_ENV: production
    RAILS_LOG_TO_STDOUT: "true"
    RAILS_SERVE_STATIC_FILES: "true"
  secret:
    - RAILS_MASTER_KEY
    - SECRET_KEY_BASE
    - REDIS_URL

# Redis para Action Cable
accessories:
  redis:
    image: redis:7-alpine
    host: 142.93.228.193
    port: 6379
    directories:
      - data:/data
    options:
      memory: 256m
    cmd: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

# Kamal uses kamal-proxy as reverse proxy (replaces Nginx)
# SSL deshabilitado (sin dominio no hay SSL)
proxy:
  ssl: false
  host: 142.93.228.193
  app_port: 3000

  # Health check to verify the app is running
  healthcheck:
    path: /up
    interval: 3
    timeout: 30

# SSH config
ssh:
  user: deploy

# Boot strategy: rolling deploys for zero downtime
boot:
  limit: 1

# Retain last 5 images
retain_containers: 5

# Builder configuration
builder:
  arch: amd64
