<% content_for(:body_class) { "bg-stone-950" } %>
<% content_for(:raw_content) { true } %>

<%= render layout: "shared/dark_layout" do %>
  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-10 gap-4">
    <div>
      <div class="flex items-center gap-4 mb-3">
        <div class="h-px w-12 bg-gradient-to-r from-transparent to-red-700/60"></div>
        <svg viewBox="0 0 24 24" class="w-5 h-5 text-red-600/60" fill="currentColor">
          <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        <div class="h-px w-12 bg-gradient-to-l from-transparent to-red-700/60"></div>
      </div>
      <h1 class="text-amber-100 tracking-[0.1em] uppercase" style="font-family: 'Cinzel', serif; font-size: 1.8rem; font-weight: 700;">
        Modo Batalla
      </h1>
      <p class="text-amber-400/80 mt-1" style="font-family: 'Cinzel', serif; font-size: 0.9rem;">
        <%= @battle_roster.warband.name %>
      </p>
      <p class="text-stone-500 mt-1" style="font-family: 'Crimson Text', serif;">
        <%= @round.display_name %> &mdash; <%= @matchup.warband_1.name %> vs <%= @matchup.warband_2.name %>
      </p>
      <div class="mt-3 flex items-center gap-4">
        <% if @battle_roster.active? %>
          <span class="px-3 py-1 text-xs text-emerald-400/80 border border-emerald-900/40 rounded bg-emerald-900/20" style="font-family: 'Cinzel', serif; font-size: 0.6rem; letter-spacing: 0.1em;">
            En batalla
          </span>
        <% else %>
          <span class="px-3 py-1 text-xs text-stone-400/80 border border-stone-700/40 rounded bg-stone-800/30" style="font-family: 'Cinzel', serif; font-size: 0.6rem; letter-spacing: 0.1em;">
            Pausada
          </span>
        <% end %>
        <span class="text-sm text-stone-400" style="font-family: 'Crimson Text', serif;">
          <span class="font-semibold text-emerald-400"><%= @battle_roster.alive_count %></span> en pie &mdash;
          <span class="font-semibold text-red-400"><%= @battle_roster.defeated_count %></span> derrotados &mdash;
          <span class="font-semibold text-amber-200/80"><%= @battle_roster.total_count %></span> total
        </span>
      </div>
    </div>
    <div class="flex flex-wrap gap-3">
      <%= button_to @battle_roster.active? ? "Pausar" : "Reactivar",
          toggle_campaign_campaign_round_matchup_battle_roster_path(@campaign, @round, @matchup, @battle_roster),
          method: :patch,
          class: "px-4 py-2 border border-amber-800/50 text-amber-400 rounded hover:bg-amber-900/20 hover:border-amber-700/60 transition-all cursor-pointer",
          style: "font-family: 'Cinzel', serif; letter-spacing: 0.1em; text-transform: uppercase; font-size: 0.7rem;" %>
      <%= button_to "Finalizar Batalla",
          campaign_campaign_round_matchup_battle_roster_path(@campaign, @round, @matchup, @battle_roster),
          method: :delete,
          data: { turbo_confirm: "Â¿Estas seguro? Se eliminara el registro de batalla." },
          class: "px-4 py-2 border border-red-800/50 text-red-400 rounded hover:bg-red-900/20 hover:border-red-700/60 transition-all cursor-pointer",
          style: "font-family: 'Cinzel', serif; letter-spacing: 0.1em; text-transform: uppercase; font-size: 0.7rem;" %>
      <%= link_to campaign_campaign_round_path(@campaign, @round), class: "px-4 py-2 border border-stone-700/50 text-stone-400 rounded hover:bg-stone-800/50 hover:border-stone-600/60 transition-all", style: "font-family: 'Cinzel', serif; letter-spacing: 0.1em; text-transform: uppercase; font-size: 0.7rem;" do %>
        Volver a Ronda
      <% end %>
    </div>
  </div>

  <!-- Units Grid -->
  <% if @units.any? %>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <% @units.each do |unit| %>
        <div class="rounded-lg border overflow-hidden transition-all duration-300 <%= unit.defeated? ? 'border-red-900/40 opacity-60' : 'border-amber-900/30 hover:border-amber-700/50' %> bg-gradient-to-b from-stone-900/80 to-stone-950/80">
          <!-- Unit Header -->
          <div class="px-4 py-3 border-b <%= unit.defeated? ? 'border-red-900/30 bg-red-950/30' : 'border-stone-800/50 bg-stone-900/50' %>">
            <div class="flex justify-between items-center">
              <div>
                <h3 class="text-amber-100" style="font-family: 'Cinzel', serif; font-size: 0.95rem;"><%= unit.warband_member.name %></h3>
                <span class="inline-block text-xs px-2 py-0.5 rounded mt-1 <%= unit.warband_member.hero? ? 'text-amber-400/80 border border-amber-900/40 bg-amber-900/20' : 'text-stone-400/80 border border-stone-700/40 bg-stone-800/30' %>" style="font-family: 'Cinzel', serif; font-size: 0.55rem; letter-spacing: 0.1em;">
                  <%= unit.warband_member.display_type %>
                </span>
              </div>
              <% if unit.defeated? %>
                <span class="px-3 py-1 text-xs text-red-400 border border-red-800/40 rounded bg-red-900/20 font-bold" style="font-family: 'Cinzel', serif; font-size: 0.6rem; letter-spacing: 0.1em;">
                  DERROTADO
                </span>
              <% end %>
            </div>
          </div>

          <!-- Wounds Tracker -->
          <div class="px-4 py-4">
            <div class="text-center mb-4">
              <p class="text-xs text-amber-200/60 tracking-wider uppercase mb-2" style="font-family: 'Cinzel', serif; font-size: 0.6rem;">Heridas</p>
              <div class="flex items-center justify-center gap-4">
                <% if @battle_roster.active? %>
                  <%= button_to wound_campaign_campaign_round_matchup_battle_roster_battle_roster_unit_path(
                      @campaign, @round, @matchup, @battle_roster, unit),
                      method: :patch,
                      class: "inline-flex items-center justify-center w-10 h-10 rounded-full #{unit.defeated? ? 'bg-stone-800/50 text-stone-600 cursor-not-allowed' : 'bg-red-900/30 text-red-400 hover:bg-red-900/50 border border-red-800/40'} text-xl font-bold transition-colors",
                      disabled: unit.defeated? do %>
                    -
                  <% end %>
                <% end %>

                <div class="text-center">
                  <span class="text-4xl font-bold <%= unit.defeated? ? 'text-red-500' : (unit.current_wounds <= 1 && unit.max_wounds > 1 ? 'text-orange-400' : 'text-amber-100') %>" style="font-family: 'Cinzel', serif;">
                    <%= unit.current_wounds %>
                  </span>
                  <span class="text-xl text-stone-600" style="font-family: 'Cinzel', serif;"> / <%= unit.max_wounds %></span>
                </div>

                <% if @battle_roster.active? %>
                  <%= button_to heal_campaign_campaign_round_matchup_battle_roster_battle_roster_unit_path(
                      @campaign, @round, @matchup, @battle_roster, unit),
                      method: :patch,
                      class: "inline-flex items-center justify-center w-10 h-10 rounded-full #{unit.current_wounds >= unit.max_wounds ? 'bg-stone-800/50 text-stone-600 cursor-not-allowed' : 'bg-emerald-900/30 text-emerald-400 hover:bg-emerald-900/50 border border-emerald-800/40'} text-xl font-bold transition-colors",
                      disabled: unit.current_wounds >= unit.max_wounds do %>
                    +
                  <% end %>
                <% end %>
              </div>

              <!-- Wound Pips -->
              <div class="flex justify-center gap-1 mt-3">
                <% unit.max_wounds.times do |i| %>
                  <div class="w-4 h-4 rounded-full border-2 <%= i < unit.current_wounds ? 'bg-red-600 border-red-500' : 'bg-stone-800 border-stone-700' %>"></div>
                <% end %>
              </div>
            </div>

            <!-- Stats Summary -->
            <div class="grid grid-cols-3 gap-1 text-xs mt-3 pt-3 border-t border-stone-800/50">
              <div class="bg-stone-900/60 p-1.5 rounded text-center border border-stone-800/30">
                <span class="font-semibold text-amber-200/50 block" style="font-family: 'Cinzel', serif; font-size: 0.5rem;">Mov</span>
                <span class="text-stone-300" style="font-family: 'Crimson Text', serif;"><%= unit.warband_member.movimiento %>"</span>
              </div>
              <div class="bg-stone-900/60 p-1.5 rounded text-center border border-stone-800/30">
                <span class="font-semibold text-amber-200/50 block" style="font-family: 'Cinzel', serif; font-size: 0.5rem;">L</span>
                <span class="text-stone-300" style="font-family: 'Crimson Text', serif;"><%= unit.warband_member.lucha %>+</span>
              </div>
              <div class="bg-stone-900/60 p-1.5 rounded text-center border border-stone-800/30">
                <span class="font-semibold text-amber-200/50 block" style="font-family: 'Cinzel', serif; font-size: 0.5rem;">F</span>
                <span class="text-stone-300" style="font-family: 'Crimson Text', serif;"><%= unit.warband_member.fuerza %></span>
              </div>
              <div class="bg-stone-900/60 p-1.5 rounded text-center border border-stone-800/30">
                <span class="font-semibold text-amber-200/50 block" style="font-family: 'Cinzel', serif; font-size: 0.5rem;">D</span>
                <span class="text-stone-300" style="font-family: 'Crimson Text', serif;"><%= unit.warband_member.defensa %></span>
              </div>
              <div class="bg-stone-900/60 p-1.5 rounded text-center border border-stone-800/30">
                <span class="font-semibold text-amber-200/50 block" style="font-family: 'Cinzel', serif; font-size: 0.5rem;">A</span>
                <span class="text-stone-300" style="font-family: 'Crimson Text', serif;"><%= unit.warband_member.ataques %></span>
              </div>
              <div class="bg-stone-900/60 p-1.5 rounded text-center border border-stone-800/30">
                <span class="font-semibold text-amber-200/50 block" style="font-family: 'Cinzel', serif; font-size: 0.5rem;">C</span>
                <span class="text-stone-300" style="font-family: 'Crimson Text', serif;"><%= unit.warband_member.coraje %></span>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="rounded-lg border border-amber-900/30 bg-gradient-to-b from-stone-900/80 to-stone-950/80 p-12 text-center">
      <h3 class="text-amber-100/80 tracking-wider uppercase mb-3" style="font-family: 'Cinzel', serif; font-size: 0.95rem;">
        Sin unidades
      </h3>
      <p class="text-stone-400" style="font-family: 'Crimson Text', serif; font-size: 1.05rem;">
        Esta warband no tiene miembros.
      </p>
    </div>
  <% end %>
<% end %>
